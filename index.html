<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢—Ä–µ–Ω–∞–∂–µ—Ä –†–∏—Ç–º—É –¥–ª—è –ë–∞—Ä–∞–±–∞–Ω—ñ–≤ | Rankova Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        .main-container {
            position: relative;
            overflow: hidden;
        }
        .drum-part {
            cursor: pointer;
            transition: transform 0.1s ease-in-out;
            transform-origin: center center;
        }
        .drum-part .drum-shape {
             transition: fill 0.1s ease-in-out, filter 0.1s ease-in-out;
        }
        .drum-part .drum-label {
            fill: white;
            font-weight: 700;
            font-size: 14px;
            text-anchor: middle;
            pointer-events: none;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        .drum-part.playing {
            transform: scale(1.05);
        }
        
        /* Default Drum Colors */
        #hi-hat .drum-shape { fill: #facc15; }
        #tom path.drum-shape { fill: #16a34a; }
        #tom ellipse.drum-shape { fill: #e0f2f1; }
        #kick .drum-shape { fill: #dc2626; }
        #snare path.drum-shape { fill: #4f46e5; }
        #snare ellipse.drum-shape { fill: #e0e7ff; }

        /* Hardcore Mode Styles */
        .hardcore-mode .drum-part .drum-shape {
            fill: #27272a !important; /* Dark gray for all shapes, !important to override specifics */
        }
        .hardcore-mode .drum-part .drum-label {
            /* Labels are now visible on hard mode */
        }
        /* Color flash on play for hardcore mode */
        .hardcore-mode .drum-part#hi-hat.playing .drum-shape { fill: #facc15 !important; }
        .hardcore-mode .drum-part#tom.playing path.drum-shape { fill: #16a34a !important; }
        .hardcore-mode .drum-part#tom.playing ellipse.drum-shape { fill: #e0f2f1 !important; }
        .hardcore-mode .drum-part#kick.playing .drum-shape { fill: #dc2626 !important; }
        .hardcore-mode .drum-part#snare.playing path.drum-shape { fill: #4f46e5 !important; }
        .hardcore-mode .drum-part#snare.playing ellipse.drum-shape { fill: #e0e7ff !important; }


        .pro-button {
            transition: all 0.2s ease-in-out;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 600;
            cursor: pointer;
            background-color: #ffd200;
            color: #1e293b;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }
        .pro-button:hover:not(:disabled) {
            background-color: #e6be00;
        }
        .pro-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .difficulty-btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid #cbd5e1;
            color: #475569;
            background-color: #f1f5f9;
            font-weight: 500;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .difficulty-btn.active {
            background-color: #ffd200;
            color: #1e293b;
            border-color: #ffd200;
        }
        .difficulty-btn:not(.active):hover {
            background-color: #e2e8f0;
        }
        
        .modal-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .leaderboard-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-radius: 8px;
        }
        .leaderboard-entry:nth-child(even) {
            background-color: #f8fafc;
        }
        .beat-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            transition: all 0.2s;
        }
    </style>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen p-4">

    <div class="container mx-auto text-center max-w-md">
        <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8 main-container">
            <!-- Game View -->
            <div id="game-view">
                <img src="https://github.com/max-vorozhko/rankova_studio_drum/blob/main/Rankova%20logo.png?raw=true" alt="–õ–æ–≥–æ—Ç–∏–ø" class="mx-auto mb-4 h-20">
                <h1 class="text-3xl md:text-4xl font-bold text-slate-800 mb-2">–¢—Ä–µ–Ω–∞–∂–µ—Ä –†–∏—Ç–º—É</h1>
                <p class="text-slate-500 mb-6">–ù–∞–±–µ—Ä–∏ —è–∫–æ–º–æ–≥–∞ –±—ñ–ª—å—à–µ –±–∞–ª—ñ–≤ –∑–∞ 1 —Ö–≤–∏–ª–∏–Ω—É!</p>
                
                <div class="flex items-center justify-between bg-slate-100 rounded-lg p-3 mb-4">
                    <div class="text-left">
                        <p class="text-sm font-medium text-slate-500">–†–ê–•–£–ù–û–ö</p>
                        <p id="score" class="text-3xl font-bold" style="color: #ffd200;">0</p>
                    </div>
                     <div class="text-left">
                        <p class="text-sm font-medium text-slate-500">–ß–ê–°</p>
                        <p id="timer" class="text-3xl font-bold text-slate-700">01:00</p>
                    </div>
                    <div class="flex items-center gap-x-2">
                        <button id="startBtn" class="pro-button">–ü–æ—á–∞—Ç–∏</button>
                    </div>
                </div>

                 <div class="flex justify-center gap-x-2 mb-2">
                    <button class="difficulty-btn active" data-difficulty="easy">–õ–µ–≥–∫–æ</button>
                    <button class="difficulty-btn" data-difficulty="medium">–°–µ—Ä–µ–¥–Ω—î</button>
                    <button class="difficulty-btn" data-difficulty="hard">–°–∫–ª–∞–¥–Ω–æ</button>
                </div>

                <div class="h-8 flex items-center justify-center">
                    <button id="toggleVisualBtn" class="text-sm text-slate-500 hover:text-slate-700 transition-colors">–°—Ö–æ–≤–∞—Ç–∏ –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—é</button>
                </div>
                
                 <div class="bg-slate-50 rounded-lg p-3 mb-4 text-center">
                     <div class="flex justify-center items-center gap-x-3 h-8" id="beat-pattern-container"></div>
                </div>

                <p id="message" class="h-6 mb-4 text-lg font-semibold text-slate-700">–û–±–µ—Ä–∏ —Å–∫–ª–∞–¥–Ω—ñ—Å—Ç—å —Ç–∞ –Ω–∞—Ç–∏—Å–Ω–∏ "–ü–æ—á–∞—Ç–∏"</p>
                
                <div class="relative w-full h-64 md:h-72 my-4">
                    <svg id="drum-kit-svg" class="w-full h-full" viewBox="0 0 300 200" preserveAspectRatio="xMidYMin meet">
                        <rect x="58" y="90" width="4" height="100" fill="#a1a1aa" rx="2"/>
                        <rect x="158" y="185" width="80" height="4" fill="#a1a1aa" rx="2"/>
                        <g id="hi-hat" class="drum-part">
                            <ellipse class="drum-shape" cx="60" cy="90" rx="50" ry="15"/>
                            <text class="drum-label" x="60" y="94">Hi-Hat</text>
                        </g>
                        <g id="tom" class="drum-part">
                            <path class="drum-shape" d="M 120,70 C 120,86 140,91 160,91 C 180,91 200,86 200,70 L 180,65 C 180,75 170,80 160,80 C 150,80 140,75 140,65 Z"/>
                            <ellipse class="drum-shape" cx="160" cy="70" rx="40" ry="15"/>
                            <text class="drum-label" x="160" y="74" fill="#1e293b">Tom</text>
                        </g>
                        <g id="kick" class="drum-part">
                           <circle class="drum-shape" cx="200" cy="135" r="55"/>
                           <text class="drum-label" x="200" y="139">Kick</text>
                        </g>
                        <g id="snare" class="drum-part">
                            <path class="drum-shape" d="M 80,130 C 80,151 105,161 130,161 C 155,161 180,151 180,130 L 160,125 C 160,141 145,145 130,145 C 115,145 100,141 100,125 Z"/>
                            <ellipse class="drum-shape" cx="130" cy="130" rx="50" ry="20"/>
                            <text class="drum-label" x="130" y="134" fill="#1e293b">Snare</text>
                        </g>
                    </svg>
                </div>

                <div class="mt-8 flex justify-between">
                    <a href="https://n813529.alteg.io" target="_blank" class="pro-button inline-block">–ó–∞–ø–∏—Å –Ω–∞ —É—Ä–æ–∫</a>
                    <button id="leaderboard-btn" class="pro-button">üèÜ –¢–∞–±–ª–∏—Ü—è –ª—ñ–¥–µ—Ä—ñ–≤</button>
                </div>
            </div>

            <!-- Leaderboard View -->
            <div id="leaderboard-view" class="hidden">
                 <h1 class="text-3xl md:text-4xl font-bold text-slate-800 mb-4">üèÜ –¢–∞–±–ª–∏—Ü—è –ª—ñ–¥–µ—Ä—ñ–≤</h1>
                 <p class="text-slate-500 mb-4">–ù–∞–π–∫—Ä–∞—â—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ –∑–∞ 1 —Ö–≤–∏–ª–∏–Ω—É</p>
                <div id="leaderboard-list" class="space-y-1 text-left max-h-96 overflow-y-auto p-2 bg-slate-50 rounded-lg">
                    <!-- Leaderboard entries go here -->
                </div>
                 <div class="mt-8">
                    <button id="back-to-game-btn" class="pro-button">–ù–∞–∑–∞–¥ –¥–æ –≥—Ä–∏</button>
                </div>
            </div>

            <!-- Save Score Modal -->
            <div id="save-score-modal" class="modal-overlay">
                <div class="bg-white p-8 rounded-xl shadow-lg text-center w-11/12 max-w-sm">
                    <h2 class="text-2xl font-bold text-slate-800">–ì—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h2>
                    <p class="text-slate-600 mt-2">–¢–≤—ñ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: <span id="final-score" class="font-bold text-xl" style="color: #ffd200;">0</span></p>
                    <p class="mt-4">–í–≤–µ–¥–∏ —Å–≤–æ—î —ñ–º'—è, —â–æ–± –∑–±–µ—Ä–µ–≥—Ç–∏ —Ä–µ–∫–æ—Ä–¥:</p>
                    <input type="text" id="player-name" maxlength="20" class="mt-2 w-full border border-slate-300 rounded-md p-2 text-center" placeholder="–¢–≤–æ—î —ñ–º'—è">
                    <div class="mt-4 flex gap-x-2">
                        <button id="save-score-btn" class="pro-button flex-1">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                        <button id="cancel-save-btn" class="pro-button flex-1" style="background-color:#f1f5f9; color:#475569;">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç–∏</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyBkhOhr5tKOoxbyISjwPY7S9VEA0NpTrVY",
            authDomain: "rankovastudiodrumleaderboard.firebaseapp.com",
            projectId: "rankovastudiodrumleaderboard",
            storageBucket: "rankovastudiodrumleaderboard.appspot.com",
            messagingSenderId: "93466705697",
            appId: "1:93466705697:web:a90ef9bbf415a155860860"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let audioCtx, gameTimerInterval, currentUnsubscribe;
        const audioBuffers = {};
        let soundsLoaded = false;
        
        const DRUM_COLORS = {
            'kick': { color: 'bg-red-500' }, 'snare': { color: 'bg-blue-500' },
            'hi-hat': { color: 'bg-yellow-400' }, 'tom': { color: 'bg-green-500' }
        };

        const drums = {
            'kick': { el: document.getElementById('kick') }, 'snare': { el: document.getElementById('snare') },
            'hi-hat': { el: document.getElementById('hi-hat') }, 'tom': { el: document.getElementById('tom') }
        };

        const elements = {
            startBtn: document.getElementById('startBtn'), scoreEl: document.getElementById('score'),
            timerEl: document.getElementById('timer'), messageEl: document.getElementById('message'),
            difficultyBtns: document.querySelectorAll('.difficulty-btn'),
            beatPatternContainer: document.getElementById('beat-pattern-container'),
            gameView: document.getElementById('game-view'), leaderboardView: document.getElementById('leaderboard-view'),
            leaderboardBtn: document.getElementById('leaderboard-btn'), backToGameBtn: document.getElementById('back-to-game-btn'),
            leaderboardList: document.getElementById('leaderboard-list'),
            saveScoreModal: document.getElementById('save-score-modal'), finalScoreEl: document.getElementById('final-score'),
            playerNameInput: document.getElementById('player-name'), saveScoreBtn: document.getElementById('save-score-btn'),
            cancelSaveBtn: document.getElementById('cancel-save-btn'),
            toggleVisualBtn: document.getElementById('toggleVisualBtn'),
            svgContainer: document.getElementById('drum-kit-svg')
        };
        
        let sequence = [], playerSequence = [], score = 0, gameActive = false, timeLeft = 60, visualsHidden = false;
        let currentDifficulty = 'easy';
        const BEAT_SPEEDS = { easy: 600, medium: 450, hard: 300 };
        
        async function init() {
            try {
                await signInAnonymously(auth);
                console.log("Anonymous sign-in successful.");
            } catch (error) {
                console.error("Anonymous sign-in failed:", error);
                handleAuthFailure();
            }
            updateTimerDisplay(timeLeft);
            setupEventListeners();
            showLeaderboard();
        }
        
        function handleAuthFailure() {
            elements.leaderboardBtn.disabled = true;
            elements.messageEl.innerHTML = `<span class="text-red-500 text-sm">–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ —Ç–∞–±–ª–∏—Ü—ñ –ª—ñ–¥–µ—Ä—ñ–≤.</span>`;
        }

        function updateTimerDisplay(seconds) {
            const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
            const secs = (seconds % 60).toString().padStart(2, '0');
            elements.timerEl.textContent = `${mins}:${secs}`;
        }
        
        async function initAudio() {
            if (soundsLoaded) return;
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') await audioCtx.resume();
            const soundUrls = {
                'kick': 'https://raw.githubusercontent.com/wesbos/JavaScript30/master/01%20-%20JavaScript%20Drum%20Kit/sounds/kick.wav',
                'snare': 'https://raw.githubusercontent.com/wesbos/JavaScript30/master/01%20-%20JavaScript%20Drum%20Kit/sounds/snare.wav',
                'hi-hat': 'https://raw.githubusercontent.com/wesbos/JavaScript30/master/01%20-%20JavaScript%20Drum%20Kit/sounds/hihat.wav',
                'tom': 'https://raw.githubusercontent.com/wesbos/JavaScript30/master/01%20-%20JavaScript%20Drum%20Kit/sounds/tom.wav'
            };
            await Promise.all(Object.keys(soundUrls).map(key => loadSound(key, soundUrls[key])));
            soundsLoaded = true;
        }

        function playSound(name) {
            if (!audioCtx || !audioBuffers[name]) return;
            const source = audioCtx.createBufferSource();
            source.buffer = audioBuffers[name];
            source.connect(audioCtx.destination);
            source.start(0);
        }

        function loadSound(name, url) {
            return fetch(url).then(r => r.arrayBuffer()).then(ab => audioCtx.decodeAudioData(ab)).then(buf => audioBuffers[name] = buf);
        }

        function animateDrum(name) {
            const drumEl = drums[name].el;
            drumEl.classList.add('playing');
            setTimeout(() => drumEl.classList.remove('playing'), 150);
        }
        
        function displayBeatPattern() {
            elements.beatPatternContainer.innerHTML = '';
            if (visualsHidden) return;
            sequence.forEach(drumName => {
                const indicator = document.createElement('div');
                indicator.className = `beat-indicator ${DRUM_COLORS[drumName].color}`;
                elements.beatPatternContainer.appendChild(indicator);
            });
        }

        async function startGame() {
            elements.startBtn.disabled = true;
            elements.startBtn.textContent = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...';
            if (!soundsLoaded) {
                try {
                    await initAudio();
                } catch (error) {
                    elements.messageEl.textContent = '–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑–≤—É–∫.';
                    elements.startBtn.disabled = false;
                    elements.startBtn.textContent = '–ü–æ—á–∞—Ç–∏';
                    return;
                }
            }
            
            score = 0;
            elements.scoreEl.textContent = 0;
            sequence = [];
            timeLeft = 60;
            updateTimerDisplay(timeLeft);
            
            elements.difficultyBtns.forEach(b => b.disabled = true);
            elements.toggleVisualBtn.disabled = true;
            elements.startBtn.textContent = '–ì—Ä–∞ —Ç—Ä–∏–≤–∞—î...';
            
            gameActive = true;
            gameTimerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay(timeLeft);
                if (timeLeft <= 0) stopGame();
            }, 1000);
            
            nextRound();
        }
        
        function stopGame() {
            gameActive = false;
            clearInterval(gameTimerInterval);
            elements.finalScoreEl.textContent = score;
            elements.saveScoreModal.classList.add('visible');
            elements.messageEl.textContent = '–ß–∞—Å –≤–∏–π—à–æ–≤!';
        }

        function nextRound() {
            if (!gameActive) return;
            playerSequence = [];
            const drumKeys = Object.keys(drums);
            const randomDrum = drumKeys[Math.floor(Math.random() * drumKeys.length)];
            sequence.push(randomDrum);
            displayBeatPattern();
            
            elements.messageEl.textContent = '–°–ª—É—Ö–∞–π!';
            let i = 0;
            const sequenceInterval = setInterval(() => {
                if (i < sequence.length) {
                    const drumName = sequence[i++];
                    animateDrum(drumName);
                    playSound(drumName);
                } else {
                    clearInterval(sequenceInterval);
                    elements.messageEl.textContent = '–¢–≤–æ—è —á–µ—Ä–≥–∞!';
                }
            }, BEAT_SPEEDS[currentDifficulty]);
        }

        function handleDrumClick(name) {
            if (!gameActive || playerSequence.length >= sequence.length) return;
            animateDrum(name);
            playSound(name);
            playerSequence.push(name);
            
            if (playerSequence[playerSequence.length - 1] !== sequence[playerSequence.length - 1]) {
                elements.messageEl.textContent = '–ü–æ–º–∏–ª–∫–∞! –°–ø—Ä–æ–±—É–π —â–µ —Ä–∞–∑.';
                 setTimeout(() => {
                    if (gameActive) nextRound();
                }, 1000); 
                return;
            }

            if (playerSequence.length === sequence.length) {
                score++;
                elements.scoreEl.textContent = score;
                setTimeout(() => {
                    if (gameActive) nextRound();
                }, 200);
            }
        }
        
        function resetGame() {
            clearInterval(gameTimerInterval);
            gameActive = false;
            elements.startBtn.disabled = false;
            elements.startBtn.textContent = '–ü–æ—á–∞—Ç–∏';
            elements.difficultyBtns.forEach(b => b.disabled = false);
            elements.toggleVisualBtn.disabled = false;
            score = 0;
            elements.scoreEl.textContent = 0;
            timeLeft = 60;
            updateTimerDisplay(timeLeft);
            elements.messageEl.textContent = '–û–±–µ—Ä–∏ —Å–∫–ª–∞–¥–Ω—ñ—Å—Ç—å —Ç–∞ –Ω–∞—Ç–∏—Å–Ω–∏ "–ü–æ—á–∞—Ç–∏"';
            elements.saveScoreModal.classList.remove('visible');
            elements.leaderboardView.classList.add('hidden');
            elements.gameView.classList.remove('hidden');
            elements.beatPatternContainer.innerHTML = '';
        }

        function showLeaderboard() {
            if (!auth.currentUser) {
                elements.leaderboardList.innerHTML = '<p class="text-center py-4 text-red-500">–ù–µ –≤–¥–∞–ª–æ—Å—è –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—è –¥–æ —Ç–∞–±–ª–∏—Ü—ñ –ª—ñ–¥–µ—Ä—ñ–≤.</p>';
                return;
            }

            if (currentUnsubscribe) currentUnsubscribe();
            const leaderboardCollection = collection(db, `drum_leaderboard_60_sec`);
            const q = query(leaderboardCollection, orderBy("score", "desc"), limit(10));
            
            const listElement = elements.leaderboardList;
            listElement.innerHTML = '<p class="text-center py-4 text-gray-500">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>';

            currentUnsubscribe = onSnapshot(q, (querySnapshot) => {
                listElement.innerHTML = '';
                if (querySnapshot.empty) {
                    listElement.innerHTML = '<p class="text-center py-4 text-gray-600">–¢–∞–±–ª–∏—Ü—è –ª—ñ–¥–µ—Ä—ñ–≤ –ø–æ—Ä–æ–∂–Ω—è. –ë—É–¥—å –ø–µ—Ä—à–∏–º!</p>';
                    return;
                }

                let rank = 1;
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const scoreValue = data.score;
                    
                    if (typeof scoreValue !== 'number' || isNaN(scoreValue)) {
                        console.warn("Skipping invalid leaderboard entry:", data);
                        return;
                    }

                    const entry = document.createElement('div');
                    entry.className = 'leaderboard-entry';
                    entry.innerHTML = `
                        <div class="flex items-center">
                            <span class="font-bold text-lg text-slate-500 w-8 text-left">${rank}.</span> 
                            <span class="ml-4 text-gray-800 font-medium truncate">${data.name || '–ê–Ω–æ–Ω—ñ–º'}</span>
                        </div>
                        <span class="font-mono text-xl text-slate-800 font-bold">${scoreValue}</span>
                    `;
                    if (rank % 2 !== 0) {
                       entry.classList.add('bg-slate-50');
                    }
                    listElement.appendChild(entry);
                    rank++;
                });

            }, (error) => {
                console.error("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Ç–∞–±–ª–∏—Ü—ñ –ª—ñ–¥–µ—Ä—ñ–≤:", error);
                listElement.innerHTML = '<p class="text-center py-4 text-red-500">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∫–æ–Ω—Å–æ–ª—å.</p>';
            });
        }
        
        function showView(viewName) {
            elements.gameView.classList.toggle('hidden', viewName !== 'game');
            elements.leaderboardView.classList.toggle('hidden', viewName !== 'leaderboard');
        }
        
        function setupEventListeners() {
            Object.keys(drums).forEach(key => drums[key].el.addEventListener('click', () => handleDrumClick(key)));
            elements.startBtn.addEventListener('click', startGame);
            
            elements.difficultyBtns.forEach(btn => btn.addEventListener('click', () => {
                if(gameActive) return;
                elements.difficultyBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentDifficulty = btn.dataset.difficulty;
                if (currentDifficulty === 'hard') {
                    elements.svgContainer.classList.add('hardcore-mode');
                } else {
                    elements.svgContainer.classList.remove('hardcore-mode');
                }
            }));

            elements.toggleVisualBtn.addEventListener('click', () => {
                visualsHidden = !visualsHidden;
                if (visualsHidden) {
                    elements.beatPatternContainer.style.visibility = 'hidden';
                    elements.toggleVisualBtn.textContent = '–ü–æ–∫–∞–∑–∞—Ç–∏ –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—é';
                } else {
                    elements.beatPatternContainer.style.visibility = 'visible';
                    elements.toggleVisualBtn.textContent = '–°—Ö–æ–≤–∞—Ç–∏ –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—é';
                    displayBeatPattern();
                }
            });

            elements.leaderboardBtn.addEventListener('click', () => {
                showView('leaderboard');
                showLeaderboard();
            });
            elements.backToGameBtn.addEventListener('click', () => showView('game'));
            
            elements.cancelSaveBtn.addEventListener('click', resetGame);
            elements.saveScoreBtn.addEventListener('click', async () => {
                if (!auth.currentUser) {
                    console.error("Authentication required to save score.");
                    alert("–ü–æ–º–∏–ª–∫–∞: –Ω–µ–º–æ–∂–ª–∏–≤–æ –∑–±–µ—Ä–µ–≥—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç. –ü–æ—Ç—Ä—ñ–±–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è.");
                    resetGame();
                    return;
                }

                const playerName = elements.playerNameInput.value.trim();
                const numericScore = parseInt(score, 10);

                if (isNaN(numericScore)) {
                    console.error("–ü–æ–º–∏–ª–∫–∞: –†–∞—Ö—É–Ω–æ–∫ –Ω–µ —î —á–∏—Å–ª–æ–º. –†–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ –∑–±–µ—Ä–µ–∂–µ–Ω–æ.");
                    resetGame();
                    return;
                }

                if (playerName && numericScore >= 0) {
                    try {
                        await addDoc(collection(db, `drum_leaderboard_60_sec`), {
                            name: playerName, score: numericScore, difficulty: currentDifficulty, timestamp: serverTimestamp()
                        });
                        resetGame();
                        elements.leaderboardBtn.click();
                    } catch (e) {
                        console.error("Error adding document: ", e);
                    }
                } else if(!playerName) {
                    alert("–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å —ñ–º'—è.");
                } else {
                    resetGame();
                }
            });
        }
        
        init();
    </script>
</body>
</html>

